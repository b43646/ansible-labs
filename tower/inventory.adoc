== Advanced Inventories

=== Dynamic Inventories

Quite often just using static inventories will not be enough. You might be dealing with ever-changing cloud environments or you have to get your managed systems from a CMDB or other sources of truth. 

Tower includes built-in support for syncing dynamic inventory from cloud sources such as Amazon AWS, Google Compute Engine, among others. Tower also offers the ability to use custom scripts to pull from your own inventory source.

In this chapter you'll get started with dynamic inventories in Tower. Aside from the build-in sources you can write inventory scripts in any programming/scripting language that you have installed on the Tower machine. To keep it easy we'll use a simple custom inventory script using... the Bash shell. 

==== The Inventory Source

First you need a source. In real life this would be your cloud provider, your CMDB or what not. For the sake of this lab we have the web server on control.example.com configured to be our source.

Open an SSH session from the control host to one of your Tower-Nodes and query your external inventory source:

----
[root@tower1-REPL ~]# curl control.example.com:/pub/inventory_list
{
    "dyngroup":{
        "hosts":[
            "cloud1",
            "cloud2"
        ],
        "vars":{
            "var1":true
        }
    },
    "_meta":{
        "hostvars":{
            "cloud1":{
                "type":"web"
            },
            "cloud2":{
                "type":"database"
            }
        }
    }
}
----

Well, this is handy, the output is already configured as JSON like Ansible would expect... ;-) Okay, seriously, in real life your script would likely get some information from your source system, format it as JSON and return the data to Tower.

==== The Custom Inventory Script

An inventory scripts has to follow some conventions. It must accept the *--list* and *--host <hostname>* arguments. When it is called with *--list*, the script must output a JSON-encoded data containing all groups to be managed. When called with *--host <hostname>* it must return an JSON-formatted hash or dictionary of host variables (can be empty).

As looping over all hosts and calling the script with *--host* can be pretty slow, it is possible to return a top level element called "_meta" with all of the host variables in one script run. And this is what we'll do. So this is our custom inventory script:

----
#!/bin/bash

if [ "$1" == "--list" ] ; then
  curl control.example.com:/pub/inventory_list  
elif [ "$1" == "--host" ]; then
  echo '{"_meta": {"hostvars": {}}}'
else
  echo "{ }"
fi
----

What it basically does is to return the data collected by curl when called with *--list* and as the data includes *_meta* information about the host variables Ansible will not call it with *--host*. The curl command is of course the place where your script  would get data by whatever means, format it as proper JSON and return it.

As simple as it gets, right? More information can be found https://docs.ansible.com/ansible/latest/dev_guide/developing_inventory.html[here]

So now you have a source of (slightly faked) inventory data and a script to fetch and pass it to Tower. Now you need to get this into Tower.

==== Integrate into Tower

The first step is to add the inventory script to Tower:

* In the web UI, open *RESOURCES->Inventory Scripts*. 
* To create a new custom inventory script, click the image:green_plus.png[20,20] button. 
* Fill in the needed data:
** *NAME:* Cloud Inventory
** Copy the Bash script from above and paste it into the *CUSTOM SCRIPT* field
* Click *SAVE*

Finally the new inventory script can be used in an actual *Inventory*.

* Go to *RESOURCES->Inventories*
* Click the image:green_plus.png[20,20] button and choose *Inventory*. 
* *NAME:* Cloud Inventory
* Click *SAVE*
* Click the *SOURCES* button on top, the image:green_plus.png[20,20] to add a new source
* *NAME:* Cloud Custom Script*
* From the *SOURCE* drop-down choose *Custom Script*
* Now the dialog for the source opens, your custom script should already be selected in the *CUSTOM INVENTORY SCRIPT*.
* Under *UPDATE OPTIONS* check *Overwrite* and *Overwrite Variables*
* Click *SAVE* 

To sync your new source into the inventory: 

* Open the *Cloud Inventory* again
* Click the *SOURCES* button
* To the left click the circular arrow to start the sync process for your custom source.
* After the sync has finished click the *HOSTS* button.

You should now see a list of hosts according to what you got from the curl command above. Click the hosts to make sure the host variables are there, too.

==== Now to the Dynamic Part...

To mimic the dynamic nature of the inventory, adapt the file we are using as source.

* Open an SSH session to your control host (if it's not open anyway).
* Edit the file `/var/www/html/pub/inventory_list` to look like this (i.e. add another host):

----
{
    "dyngroup":{
        "hosts":[
            "cloud1.cloud.example.com",
            "cloud2.cloud.example.com",
            "cloud3.cloud.example.com"
        ],
        "vars":{
            "var1": true
        }
    },
    "_meta":{
        "hostvars":{
            "cloud1.cloud.example.com":{
                "type":"web"
            },
            "cloud2.cloud.example.com":{
                "type":"database"
            },
            "cloud3.cloud.example.com":{
                "type":"database"
            }
        }
    }
}
----

After saving the file: 

* Go back to web UI, open the *Cloud Inventory* inventory
* Click the *SOURCES* button and re-sync the *Cloud Custom Script* source.
* Open the *HOSTS* view again and make sure you have three hosts listed.


